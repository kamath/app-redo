<template name="home">
    <div class="navbar-fixed red darken-4">
        <nav class="red darken-4">
            <div class="nav-wrapper">
                <div class="container">
                    <a href="#!" class="brand-logo title center">U2TR</a> {{#if home}}
                    <a href="" onclick="FlowRouter.go('/profile')" class="fa fa-gear"></a>{{else}}<a onclick="history.back();"><i class="fa fa-arrow-left"></i></a>{{/if}}
                </div>
            </div>
        </nav>
    </div>
    {{> Template.dynamic template=template}}
    <script type="text/javascript">
    $("body").css('background', '#FFF');
    $(".fa-gear").css('font-size', $(".brand-logo").css('font-size'))
    </script>
</template>
<template name="page">
    {{#each things}}
    <div class="row" align="left">
        <div class="col s12 m6">
            <div class="card blue-grey darken-1">
                <div class="card-content white-text">
                    <span class="card-title">{{subject}}</span>
                    <p><strong>When:</strong> {{date}}</p>
                    <p><strong>People coming: </strong> {{#each peoplegoing}}<img src="http://graph.facebook.com/{{this}}/picture/?type=large" height="20px" style="vertical-align: middle;border-radius: 50%"> {{/each}}</p>
                </div>
                <div class="card-action">
                    {{#if notjoined}}<a href="#" onclick="join('{{_id}}')">Join</a>{{/if}}
                    <a href="/teach/{{_id}}">Teach</a>
                    <a href="/directions/{{lat}},{{lng}}">Directions</a>
                    <a href="#" onclick="share('{{_id}}')">Share</a>
                </div>
            </div>
        </div>
    </div>
    {{/each}}
    <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
        <a class="btn-floating btn-large red darken-4" href="/add">
            <i class="fa fa-plus"></i>
        </a>
        <ul>
            <li onclick="immediate()"><a class="btn-floating red"><i class="fa fa-clock-o"></i></a></li>
            <li onclick="Session.set('immediate', false);FlowRouter.go('/add')"><a class="btn-floating yellow darken-1"><i class="fa fa-calendar-o"></i></a></li>
        </ul>
    </div>
    <script type="text/javascript">
    function immediate() {
        var r = confirm('Immediate requests cost 10% extra. Are you sure?');
        if (r) {
            Session.set('immediate', true)
            FlowRouter.go('/add')
        }
    }

    function join(id) {
        r = confirm("Are you sure you want to join?")
        if (r) {
            event = Events.findOne(id)
            peoplegoing = event.peoplegoing;
            peoplegoing.push(Meteor.user().services.facebook.id)
            console.log(peoplegoing)
            Events.update(id, {
                $set: {
                    peoplegoing: peoplegoing
                },
            });
            alert('You have successfully joined ' + event.subject + '!')
            FlowRouter.go('/')
        }
    }

    function share(id) {
        var message = {
            text: "Join my tutoring session!",
            url: "http://u2tr.herokuapp.com/join/"+id
        };
        window.socialmessage.send(message);
    }
    </script>
</template>
<template name="add">
    <div class="container">
        <center>
            <h3>{{immediate}}</h3>
        </center>
        <div class="row">
            <form class="col s12" id="add">
                <p>Class/Subject Name</p>
                <input type="text" name="class"> {{#if test}}
                <div class="row">
                    <div class="input-field col s12">
                        <p>Date & Time</p>
                        <input type="datetime-local" placeholder="Date & Time" name="date">
                    </div>
                </div>
                <p onclick="test()">
                    <input type="checkbox" class="filled-in" id="test5" name="private" />
                    <label for="test5">Make this event private</label>
                </p>
                <p onclick="test2()">
                    <input type="checkbox" class="filled-in" id="test6" name="private" />
                    <label for="test6">Make this event immediate</label>
                </p>
                <center><a class="waves-effect waves-light red darken-4 btn" id="setlocation"><i class="fa fa-globe left"></i>Set Location</a></center>
                <br> {{/if}}
                <center>
                    <button type="submit" class="waves-effect waves-light btn"><i class="fa fa-check left"></i>Submit</button>
                </center>
            </form>
        </div>
    </div>
    <script type="text/javascript">
    function test() {
        if (document.getElementById('test5').checked && !Session.get('check')) {
            r = confirm('Private events are an extra 10% of your tutoring fee. Continue?');
            if (r) {
                document.getElementById("test5").checked = true;
                Session.set('check', true)
            } else {
                document.getElementById("test5").checked = false;
            }
        }
    }

    function test2() {
        if (document.getElementById('test6').checked && !Session.get('check2')) {
            r = confirm('Immediate events are an extra 10% of your tutoring fee. Continue?');
            if (r) {
                document.getElementById("test6").checked = true;
                Session.set('check2', true)
            } else {
                document.getElementById("test6").checked = false;
            }
        }
    }
    $("#setlocation").click(function() {
        console.log($("[name='class']").val());
        console.log($("[name='date']").val());
        console.log(document.getElementById("test5").checked);
        Session.set('class', $("[name='class']").val());
        Session.set('date', $("[name='date']").val());
        Session.set('private', document.getElementById("test5").checked);
        FlowRouter.go('/map')
    });
    $("[name='class']").val(Session.get('class'));
    $("[name='date']").val(Session.get('date'));
    document.getElementById("test5").checked = Session.get('private')
    </script>
</template>
<template name="map">
    <div class="map-container" align="center" style="height: 100%;width: 100%">
        <div id="map"></div>
        <h1 class="element" style="position: fixed;width: 100%;z-index: 100">x</h1>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?callback=intialize" async defer></script>
    <script>
    var mapCanvas;
    console.log(Session.get('loc').curValue.lat)
    function intialize() {
        //Create a map
            mapCanvas = new google.maps.Map(document.getElementById("map"));
            if (!Session.get('coords')) {
                mapCanvas.setCenter(new google.maps.LatLng(Session.get('loc').curValue.lat, Session.get('loc').curValue.lng));
                mapCanvas.setZoom(13);
            } else {
                mapCanvas.setCenter(new google.maps.LatLng(parseFloat(Session.get('coords').split(',')[0]), parseFloat(Session.get('coords').split(',')[1])));
                mapCanvas.setZoom(15);
            }
            mapCanvas.setMapTypeId(google.maps.MapTypeId.ROADMAP);

            //Retrive the center location
            google.maps.event.addListener(mapCanvas, "center_changed", function() {
                Session.set('coords', mapCanvas.getCenter().toUrlValue())
            });

    }
    google.maps.event.addDomListener(window, "load", intialize);

    function getcenter() {
        console.log(Session.get('coords'));
        history.back();
    }
    </script>
</template>
<template name="directions">
    <iframe src="{{url}}" id="iframe"></iframe>
    <script type="text/javascript">
    $("#iframe").css('height', $(window).height() - $(".navbar-fixed").height())
    $("#iframe").css('width', $(window).width())
    </script>
</template>
